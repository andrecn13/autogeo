var app=angular.module("AutoGeoApp",["leaflet-directive","ngRoute","ui.utils.masks","ui.bootstrap"]);app.config(["$routeProvider","$httpProvider",function($routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/mapa.html",controller:"MapaCtrl"}).when("/favoritos",{templateUrl:"views/favoritos.html",controller:"FavoritosCtrl"}).otherwise({template:"<h3><strong>404</strong> Página não encontrada</h3>"})}]),app.controller("MapaCtrl",["$scope","$rootScope","$filter","$modal","MapaService",function($scope,$rootScope,$filter,$modal,MapaService){$scope.title="Mapa",$scope.anunciosMarkers=[],$scope.anunciosMarkers2=[],$scope.enableMenu=!1,$scope.marcas=[{nome:"Selecione uma marca"},{nome:"Chevrolet"},{nome:"Ford"},{nome:"Fiat"},{nome:"Wolkswagen"},{nome:"Renault"},{nome:"Pegeout"},{nome:"Toyota"}],$scope.filtro={preco:{minVal:"",maxVal:"",ativo:!1},km:{minKm:"",maxKm:"",ativo:!1},ano:{minAno:"",maxAno:"",ativo:!1},marca:{marca:"",ativo:!1},modelo:"",portas:{qtdPortas:0,ativo:!1},estado:{estadoAutomovel:0,ativo:!1},fotos:{fotos:0,ativo:!1}};var promiseAnuncios=MapaService.getAnuncios();promiseAnuncios.then(function(data){$rootScope.anuncios=data.anuncios,angular.forEach(data.anuncios,function(anuncio,i){$scope.anunciosMarkers.push({lat:anuncio.geometry.coordinates[1],lng:anuncio.geometry.coordinates[0],message:"<popup anuncio='anuncios["+i+"]'></popup>",popupOptions:{minWidth:200,maxWidth:200},props:anuncio.properties})}),$scope.anunciosMarkers2=$scope.anunciosMarkers}),angular.extend($scope,{defaults:{},center:{lat:-30.0257548,lng:-51.1833013,zoom:12}}),$scope.$watch("filtro.modelo",function(newVal,oldVal){$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}),$scope.filtrarAnuncio=function(){$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)},$scope.limparFiltro=function(type){switch(type){case"preco":$scope.filtro.preco.minVal="",$scope.filtro.preco.maxVal="",$scope.filtro.preco.ativo=!1;break;case"km":$scope.filtro.km.minKm="",$scope.filtro.km.maxKm="",$scope.filtro.km.ativo=!1;break;case"ano":$scope.filtro.ano.minAno="",$scope.filtro.ano.maxAno="",$scope.filtro.ano.ativo=!1;break;case"marca":$scope.filtro.marca.marca=$scope.marcas[0],$scope.filtro.marca.ativo=!1;break;case"portas":$scope.filtro.portas.qtdPortas=0,$scope.filtro.portas.ativo=!1;break;case"estado":$scope.filtro.estado.estadoAutomovel=0,$scope.filtro.estado.ativo=!1;break;case"fotos":$scope.filtro.fotos.fotos=0,$scope.filtro.fotos.ativo=!1;break;default:$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}}]),app.controller("FavoritosCtrl",["$scope",function($scope){$scope.title="Meus Favoritos"}]),app.controller("PopUpCtrl",["$scope","$modal",function($scope,$modal){$scope.openDetail=function(){$modal.open({animation:!0,templateUrl:"partials/modal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{anuncio:function(){return $scope.anuncio}}})}}]),app.controller("ModalInstanceCtrl",function($scope,$modalInstance,anuncio){$scope.anuncio=anuncio,$scope.ok=function(){$modalInstance.dismiss("cancel")}}),app.directive("enableMenu",function(){return{restric:"A",link:function(scope,elem,attrs){"glyphicon glyphicon-menu-up";elem.on("click",function(){$(elem).toggleClass(function(){return $(elem).is(".glyphicon-menu-down")?"glyphicon-menu-up":"glyphicon-menu-down"}),$("#containerFiltros").slideToggle("medium")})}}}),app.directive("popup",[function(){return{restrict:"E",scope:{anuncio:"="},templateUrl:"partials/popup.html",controller:"PopUpCtrl"}}]),app.directive("activeLink",["$location",function(location){return{restrict:"A",link:function(scope,element,attrs,controller){var clazz=attrs.activeLink,path=attrs.href;path=path.substring(1),scope.location=location,scope.$watch("location.path()",function(newPath){path===newPath?element.addClass(clazz):element.removeClass(clazz)})}}}]),app.filter("filter",[function(){return function(markers,obj){var matches=[];return angular.forEach(markers,function(marker,featureKey){marker.match=!0,""!=obj.preco.minVal&&1==marker.match&&(marker.props.valor>=obj.preco.minVal?marker.match=!0:marker.match=!1,obj.preco.ativo=!0),""!=obj.preco.maxVal&&1==marker.match&&(marker.props.valor<=obj.preco.maxVal?marker.match=!0:marker.match=!1,obj.preco.ativo=!0),""!=obj.km.minKm&&1==marker.match&&(marker.props.km>=obj.km.minKm?marker.match=!0:marker.match=!1,obj.km.ativo=!0),""!=obj.km.maxKm&&1==marker.match&&(marker.props.km<=obj.km.maxKm?marker.match=!0:marker.match=!1,obj.km.ativo=!0),""!=obj.ano.minAno&&1==marker.match&&(marker.props.ano>=obj.ano.minAno?marker.match=!0:marker.match=!1,obj.ano.ativo=!0),""!=obj.ano.maxAno&&1==marker.match&&(marker.props.ano<=obj.ano.maxAno?marker.match=!0:marker.match=!1,obj.ano.ativo=!0),""!=obj.modelo&&1==marker.match&&(marker.props.modelo.toUpperCase().indexOf(obj.modelo.toUpperCase())>-1?marker.match=!0:marker.match=!1),"Selecione uma marca"!=obj.marca.marca.nome&&1==marker.match&&(marker.props.marca.toUpperCase().indexOf(obj.marca.marca.nome.toUpperCase())>-1?marker.match=!0:marker.match=!1,obj.marca.ativo=!0),0==obj.qtdPortas&&1==marker.match?(marker.match=!0,obj.portas.ativo=!1):obj.portas.qtdPortas>0&&1==marker.match&&(marker.props.portas==obj.portas.qtdPortas?marker.match=!0:marker.match=!1,obj.portas.ativo=!0),0==obj.estado.estadoAutomovel&&1==marker.match?(marker.match=!0,obj.estado.ativo=!1):obj.estado.estadoAutomovel>0&&1==marker.match&&(marker.props.estado==obj.estado.estadoAutomovel?marker.match=!0:marker.match=!1,obj.estado.ativo=!0),0==obj.fotos.fotos&&1==marker.match?(marker.match=!0,obj.fotos.ativo=!1):1==obj.fotos.fotos&&1==marker.match?(marker.props.fotos.length>0?marker.match=!0:marker.match=!1,obj.fotos.ativo=!0):2==obj.fotos.fotos&&1==marker.match&&(0==marker.props.fotos?marker.match=!0:marker.match=!1,obj.fotos.ativo=!0),1==marker.match&&matches.push(marker)}),matches}}]),app.factory("MapaService",function($http,$q){return{getAnuncios:function(){var d=$q.defer(),url="data_sample/carros.json",saida={anuncios:[]};return $http.get(url).success(function(anuncios){angular.forEach(anuncios.features,function(anuncio){saida.anuncios.push(anuncio)}),d.resolve(saida)}).error(function(msg,code){d.reject(msg)}),d.promise}}});