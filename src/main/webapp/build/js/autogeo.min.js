var app=angular.module("AutoGeoApp",["leaflet-directive","ngRoute","ngResource","ui.utils.masks","ui.bootstrap"]);app.config(["$routeProvider","$httpProvider",function($routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/mapa.html",controller:"MapaCtrl",access:{requiredLogin:!1}}).when("/favoritos",{templateUrl:"views/favoritos.html",controller:"FavoritosCtrl",access:{requiredLogin:!0}}).when("/cadastro",{templateUrl:"views/cadastro.html",controller:"CadastroCtrl",access:{requiredLogin:!1}}).when("/cadastro/anuncio",{templateUrl:"views/cadastroAnuncio.html",controller:"AnuncioCtrl",access:{requiredLogin:!0}}).when("/anuncios",{templateUrl:"views/anuncios.html",controller:"AnuncioCtrl",access:{requiredLogin:!0}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",access:{requiredLogin:!1}}).otherwise({template:"<h3><strong>404</strong> Página não encontrada</h3>"}),$httpProvider.interceptors.push("TokenInterceptor")}]),app.run(function($rootScope,$location,AuthenticationService){$rootScope.$on("$routeChangeStart",function(event,nextRoute,currentRoute){$rootScope.alerts=[],nextRoute.access.requiredLogin&&!AuthenticationService.isLogged()&&$location.path("/login")}),$rootScope.go=function(path){$location.path(path)},$rootScope.showElement=function(){return AuthenticationService.isLogged()?!0:!1},$rootScope.userName=function(){return AuthenticationService.getUser()}}),app.controller("AnuncioCtrl",["$scope","MapaService",function($scope,MapaService){$scope.title="Meus Anuncios",$scope.anuncios=[];var promiseAnuncios=MapaService.getAnuncios();promiseAnuncios.then(function(data){$scope.anuncios=data.anuncios});var mainMarker={lat:-30.0257548,lng:-51.1833013,focus:!0,message:"Mova o marker para posicionar a localizção do automóvel",draggable:!0};angular.extend($scope,{defaults:{},center:{lat:-30.0257548,lng:-51.1833013,zoom:12},markers:{mainMarker:angular.copy(mainMarker)}})}]),app.controller("CadastroCtrl",["$scope","CadastroFactory","AlertService","$timeout","$window",function($scope,CadastroFactory,AlertService,$timeout,$window){$scope.title="Cadastro",$scope.user={whatsapp:"true"},$scope.cadastrarUsuario=function(){CadastroFactory.create($scope.user,function(){$scope.user={whatsapp:"true"},$("#contentContainer").animate({scrollTop:0},200),AlertService.add("success","Cadastro realizado com sucesso."),$timeout(function(){AlertService.clear()},3e3)},function(){AlertService.add("danger","Erro ao salvar dados.")})}}]),app.controller("FavoritosCtrl",["$scope",function($scope){$scope.title="Meus Favoritos"}]),app.controller("LoginCtrl",["$scope","$location","$window","LoginService","AuthenticationService","AlertService",function($scope,$location,$window,LoginService,AuthenticationService,AlertService){$scope.user={},$scope.login=function(){void 0!==$scope.user.email&&void 0!==$scope.user.senha&&LoginService.login($scope.user,function(data){$window.sessionStorage.token=data.token,$location.path("/")},function(status,data){AlertService.add("danger","Login Inválido.")})},$scope.logout=function(){AuthenticationService.isLogged()&&(delete $window.sessionStorage.token,$location.path("/login"))}}]),app.controller("MapaCtrl",["$scope","$rootScope","$filter","$modal","MapaService",function($scope,$rootScope,$filter,$modal,MapaService){$scope.title="Mapa",$scope.anunciosMarkers=[],$scope.anunciosMarkers2=[],$scope.enableMenu=!1,$scope.marcas=[{nome:"Selecione uma marca"},{nome:"Chevrolet"},{nome:"Ford"},{nome:"Fiat"},{nome:"Wolkswagen"},{nome:"Renault"},{nome:"Pegeout"},{nome:"Toyota"}],$scope.filtro={preco:{minVal:"",maxVal:"",ativo:!1},km:{minKm:"",maxKm:"",ativo:!1},ano:{minAno:"",maxAno:"",ativo:!1},marca:{marca:"",ativo:!1},modelo:"",portas:{qtdPortas:0,ativo:!1},estado:{estadoAutomovel:0,ativo:!1},fotos:{fotos:0,ativo:!1}};var promiseAnuncios=MapaService.getAnuncios();promiseAnuncios.then(function(data){$rootScope.anuncios=data.anuncios,angular.forEach(data.anuncios,function(anuncio,i){$scope.anunciosMarkers.push({layer:"anuncios",lat:anuncio.geometry.coordinates[1],lng:anuncio.geometry.coordinates[0],message:"<popup anuncio='anuncios["+i+"]'></popup>",popupOptions:{minWidth:200,maxWidth:200},props:anuncio.properties})}),$scope.anunciosMarkers2=$scope.anunciosMarkers}),angular.extend($scope,{defaults:{},center:{lat:-30.0257548,lng:-51.1833013,zoom:12},layers:{baselayers:{osm:{name:"OpenStreetMap",type:"xyz",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}},overlays:{anuncios:{name:"Anúncios",type:"markercluster",visible:!0}}}}),$scope.$watch("filtro.modelo",function(newVal,oldVal){$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}),$scope.filtrarAnuncio=function(){$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)},$scope.limparFiltro=function(type){switch(type){case"preco":$scope.filtro.preco.minVal="",$scope.filtro.preco.maxVal="",$scope.filtro.preco.ativo=!1;break;case"km":$scope.filtro.km.minKm="",$scope.filtro.km.maxKm="",$scope.filtro.km.ativo=!1;break;case"ano":$scope.filtro.ano.minAno="",$scope.filtro.ano.maxAno="",$scope.filtro.ano.ativo=!1;break;case"marca":$scope.filtro.marca.marca=$scope.marcas[0],$scope.filtro.marca.ativo=!1;break;case"portas":$scope.filtro.portas.qtdPortas=0,$scope.filtro.portas.ativo=!1;break;case"estado":$scope.filtro.estado.estadoAutomovel=0,$scope.filtro.estado.ativo=!1;break;case"fotos":$scope.filtro.fotos.fotos=0,$scope.filtro.fotos.ativo=!1;break;default:$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}}]),app.controller("ModalCtrl",function($scope,$modalInstance,anuncio){$scope.anuncio=anuncio,$scope.ok=function(){$modalInstance.dismiss("cancel")}}),app.controller("PopUpCtrl",["$scope","$modal",function($scope,$modal){$scope.openDetail=function(){$modal.open({animation:!0,templateUrl:"partials/modal.html",controller:"ModalCtrl",size:"md",resolve:{anuncio:function(){return $scope.anuncio}}})}}]),app.directive("enableMenu",function(){return{restric:"A",link:function(scope,elem,attrs){"glyphicon glyphicon-menu-up";elem.on("click",function(){$(elem).toggleClass(function(){return $(elem).is(".glyphicon-menu-down")?"glyphicon-menu-up":"glyphicon-menu-down"}),$("#containerFiltros").slideToggle("medium")})}}}),app.directive("popup",[function(){return{restrict:"E",scope:{anuncio:"="},templateUrl:"partials/popup.html",controller:"PopUpCtrl"}}]),app.directive("activeLink",["$location",function(location){return{restrict:"A",link:function(scope,element,attrs,controller){var clazz=attrs.activeLink,path=attrs.href;path=path.substring(1),scope.location=location,scope.$watch("location.path()",function(newPath){path===newPath?element.addClass(clazz):element.removeClass(clazz)})}}}]),app.directive("overflowDirective",["$location",function(location){return{restrict:"A",link:function(scope,element,attrs){"/"!=location.path()?$(element).css("overflow","auto"):$(element).css("overflow","hidden")}}}]),app.filter("filter",[function(){return function(markers,obj){var matches=[];return angular.forEach(markers,function(marker,featureKey){marker.match=!0,""!=obj.preco.minVal&&1==marker.match&&(marker.props.valor>=obj.preco.minVal?marker.match=!0:marker.match=!1,obj.preco.ativo=!0),""!=obj.preco.maxVal&&1==marker.match&&(marker.props.valor<=obj.preco.maxVal?marker.match=!0:marker.match=!1,obj.preco.ativo=!0),""!=obj.km.minKm&&1==marker.match&&(marker.props.km>=obj.km.minKm?marker.match=!0:marker.match=!1,obj.km.ativo=!0),""!=obj.km.maxKm&&1==marker.match&&(marker.props.km<=obj.km.maxKm?marker.match=!0:marker.match=!1,obj.km.ativo=!0),""!=obj.ano.minAno&&1==marker.match&&(marker.props.ano>=obj.ano.minAno?marker.match=!0:marker.match=!1,obj.ano.ativo=!0),""!=obj.ano.maxAno&&1==marker.match&&(marker.props.ano<=obj.ano.maxAno?marker.match=!0:marker.match=!1,obj.ano.ativo=!0),""!=obj.modelo&&1==marker.match&&(marker.props.modelo.toUpperCase().indexOf(obj.modelo.toUpperCase())>-1?marker.match=!0:marker.match=!1),"Selecione uma marca"!=obj.marca.marca.nome&&1==marker.match&&(marker.props.marca.toUpperCase().indexOf(obj.marca.marca.nome.toUpperCase())>-1?marker.match=!0:marker.match=!1,obj.marca.ativo=!0),0==obj.qtdPortas&&1==marker.match?(marker.match=!0,obj.portas.ativo=!1):obj.portas.qtdPortas>0&&1==marker.match&&(marker.props.portas==obj.portas.qtdPortas?marker.match=!0:marker.match=!1,obj.portas.ativo=!0),0==obj.estado.estadoAutomovel&&1==marker.match?(marker.match=!0,obj.estado.ativo=!1):obj.estado.estadoAutomovel>0&&1==marker.match&&(marker.props.estado==obj.estado.estadoAutomovel?marker.match=!0:marker.match=!1,obj.estado.ativo=!0),0==obj.fotos.fotos&&1==marker.match?(marker.match=!0,obj.fotos.ativo=!1):1==obj.fotos.fotos&&1==marker.match?(marker.props.fotos.length>0?marker.match=!0:marker.match=!1,obj.fotos.ativo=!0):2==obj.fotos.fotos&&1==marker.match&&(0==marker.props.fotos?marker.match=!0:marker.match=!1,obj.fotos.ativo=!0),1==marker.match&&matches.push(marker)}),matches}}]),app.factory("AlertService",["$rootScope",function($rootScope){var alertService={};return $rootScope.alerts=[],alertService.add=function(type,msg){$rootScope.alerts=[],$rootScope.alerts.push({type:type,msg:msg})},alertService.clear=function(){$rootScope.alerts=[]},alertService}]),app.factory("AuthenticationService",["$window",function($window){var auth={isLogged:function(){return void 0==$window.sessionStorage.token?!1:!0},getUser:function(){return void 0!=$window.sessionStorage.token?JSON.parse(atob($window.sessionStorage.token.split(".")[1])).nome:""}};return auth}]),app.factory("CadastroFactory",function($resource){return $resource("usuario/salvar",{},{create:{method:"POST"}})}),app.factory("LoginService",function($resource){return $resource("usuario/login",{},{login:{method:"POST"}})}),app.factory("MapaService",function($http,$q){return{getAnuncios:function(){var d=$q.defer(),url="data_sample/carros.json",saida={anuncios:[]};return $http.get(url).success(function(anuncios){angular.forEach(anuncios.features,function(anuncio){saida.anuncios.push(anuncio)}),d.resolve(saida)}).error(function(msg,code){d.reject(msg)}),d.promise}}}),app.factory("TokenInterceptor",["$q","$window","AuthenticationService",function($q,$window,AuthenticationService){return{request:function(config){return config.headers=config.headers||{},$window.sessionStorage.token&&(config.headers.Authorization="Bearer "+$window.sessionStorage.token),config},requestError:function(rejection){return $q.reject(rejection)},response:function(response){return response||$q.when(response)},responseError:function(rejection){return $q.reject(rejection)}}}]);