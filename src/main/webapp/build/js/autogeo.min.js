var app=angular.module("AutoGeoApp",["leaflet-directive","ngRoute","ngResource","ui.utils.masks","ui.bootstrap"]);app.config(["$routeProvider","$httpProvider",function($routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/mapa.html",controller:"MapaCtrl",access:{requiredLogin:!1,blockWhenLogged:!1}}).when("/visualizar/:id",{templateUrl:"views/mapa.html",controller:"MapaCtrl",access:{requiredLogin:!1,blockWhenLogged:!1}}).when("/favoritos",{templateUrl:"views/favoritos.html",controller:"FavoritosCtrl",access:{requiredLogin:!0,blockWhenLogged:!1}}).when("/cadastro",{templateUrl:"views/tipoCadastro.html",access:{requiredLogin:!1,blockWhenLogged:!0}}).when("/cadastro/:tipo",{templateUrl:"views/cadastro.html",controller:"CadastroCtrl",access:{requiredLogin:!1,blockWhenLogged:!0}}).when("/anuncio/novo",{templateUrl:"views/cadastroAnuncio.html",controller:"AnuncioCadastroCtrl",access:{requiredLogin:!0,blockWhenLogged:!1}}).when("/anuncio/editar/:id",{templateUrl:"views/editarAnuncio.html",controller:"AnuncioEditarCtrl",access:{requiredLogin:!0,blockWhenLogged:!1}}).when("/anuncios",{templateUrl:"views/anuncios.html",controller:"AnuncioCtrl",access:{requiredLogin:!0,blockWhenLogged:!1}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",access:{requiredLogin:!1,blockWhenLogged:!1}}).otherwise({template:"<h3><strong>404</strong> Página não encontrada</h3>"}),$httpProvider.interceptors.push("TokenInterceptor")}]),app.run(function($rootScope,$location,AuthenticationService){$rootScope.$on("$routeChangeStart",function(event,nextRoute,currentRoute){$rootScope.alerts=[],nextRoute.access.requiredLogin&&!AuthenticationService.isLogged()&&$location.path("/login"),nextRoute.access.blockWhenLogged&&AuthenticationService.isLogged()&&$location.path("/")}),$rootScope.go=function(path){$location.path(path)},$rootScope.showElement=function(){return AuthenticationService.isLogged()?!0:!1},$rootScope.userName=function(){return AuthenticationService.getUser()},$rootScope.closeAlert=function(index){$rootScope.alerts.splice(index,1)}}),app.controller("CadastroCtrl",["$scope","CadastroFactory","AlertService","$routeParams","MapaService",function($scope,CadastroFactory,AlertService,$routeParams,MapaService){$scope.tipo=$routeParams.tipo,$scope.title="Cadastro",$scope.user={loja:null},$scope.cadastrarUsuario=function(){console.log(angular.toJson($scope.user)),CadastroFactory.create($scope.user,function(){AlertService.add("success","Cadastro realizado com sucesso."),$("#contentContainer").animate({scrollTop:0},200),$scope.user={}},function(){AlertService.add("danger","Erro ao salvar dados."),$("#contentContainer").animate({scrollTop:0},200)})};var mainMarker={lat:-30.0257548,lng:-51.1833013,focus:!0,message:"Clique e mova para posicionar o seu estabelecimento",draggable:!0};angular.extend($scope,{defaults:{},center:{lat:-30.0257548,lng:-51.1833013,zoom:12},markers:{mainMarker:angular.copy(mainMarker)}}),$scope.$on("leafletDirectiveMarker.dragend",function(event,args){var lat=args.model.lat,lng=args.model.lng;$scope.user.loja.localizacao="POINT ("+lat+" "+lng+")"}),$scope.geocode=function(){MapaService.geocode($scope.endereco).then(function(data){data.results[0].locations.length>0&&($scope.markers.mainMarker.lat=data.results[0].locations[0].latLng.lat,$scope.markers.mainMarker.lng=data.results[0].locations[0].latLng.lng,$scope.center.lat=data.results[0].locations[0].latLng.lat,$scope.center.lng=data.results[0].locations[0].latLng.lng,$scope.user.loja.localizacao="POINT ("+data.results[0].locations[0].latLng.lat+" "+data.results[0].locations[0].latLng.lng+")")},function(data){console.log(data)})}}]),app.controller("AnuncioCtrl",["$scope","AnuncioService",function($scope,AnuncioService){$scope.title="Meus Anuncios",$scope.anuncios=[];var promiseAnuncios=AnuncioService.getAnuncios();promiseAnuncios.then(function(data){$scope.anuncios=data})}]),app.controller("AnuncioCadastroCtrl",["$scope","AnuncioService","AlertService","AuthenticationService","MapaService",function($scope,AnuncioService,AlertService,AuthenticationService,MapaService){$scope.isLoja=AuthenticationService.isLoja(),$scope.anuncio={acessorios:[]},$scope.marcas=[],$scope.acessorios=[],$scope.cores=[],$scope.combustiveis=[],$scope.modelos=[],$scope.files=[],$scope.$on("fileSelected",function(event,args){$scope.$apply(function(){$scope.files.length<3&&$scope.files.push(args.file)})});var promisseData=AnuncioService.getData();promisseData.then(function(data){$scope.marcas=data.marcas,$scope.acessorios=data.acessorios,$scope.cores=data.cores,$scope.combustiveis=data.combustiveis}),$scope.addAcessorio=function(){$scope.anuncio.acessorios.push($scope.selectedAcessorio)},$scope.limparAcessorios=function(){$scope.anuncio.acessorios=[]},$scope.getModelo=function(marca){if(null!=marca){var promisseModelo=AnuncioService.getModelo(marca);promisseModelo.then(function(data){$scope.modelos=data},function(data){$scope.modelos=[]})}},$scope.cadastrarAnuncio=function(){var promisseSalvar=AnuncioService.salvar($scope.anuncio,$scope.files);promisseSalvar.then(function(data){AlertService.add("success","Anúncio cadastrado com sucesso."),$("#contentContainer").animate({scrollTop:0},200),$scope.anuncio={acessorios:[],localizacao:{}},$scope.files=[]},function(data){AlertService.add("danger","Erro ao realizar cadastro, verifique os dados."),$("#contentContainer").animate({scrollTop:0},200)})};var mainMarker={lat:-30.0257548,lng:-51.1833013,focus:!0,message:"Mova o marker para posicionar a localizção do automóvel",draggable:!0};angular.extend($scope,{defaults:{},center:{lat:-30.0257548,lng:-51.1833013,zoom:12},markers:{mainMarker:angular.copy(mainMarker)}}),$scope.$on("leafletDirectiveMarker.dragend",function(event,args){var lat=args.model.lat,lng=args.model.lng;$scope.anuncio.localizacao="POINT ("+lat+" "+lng+")"}),$scope.geocode=function(){MapaService.geocode($scope.endereco).then(function(data){data.results[0].locations.length>0&&($scope.markers.mainMarker.lat=data.results[0].locations[0].latLng.lat,$scope.markers.mainMarker.lng=data.results[0].locations[0].latLng.lng,$scope.center.lat=data.results[0].locations[0].latLng.lat,$scope.center.lng=data.results[0].locations[0].latLng.lng,$scope.anuncio.localizacao="POINT ("+data.results[0].locations[0].latLng.lat+" "+data.results[0].locations[0].latLng.lng+")")},function(data){console.log(data)})},$scope.consultaFipe=function(){void 0!=$scope.anuncio.modelo&&void 0!=$scope.anuncio.combustivel&&void 0!=$scope.anuncio.ano?AnuncioService.getPrecoFipe($scope.anuncio).then(function(data){$scope.anuncio.valor=data.preco},function(data){$scope.fipeErro="Veículo não encontrado na FIPE."}):$scope.fipeErro="Preencha as informações do veículo e consulte novamente."},$scope.fechar=function(){$scope.fipeErro=void 0}}]),app.controller("AnuncioEditarCtrl",["$scope","AnuncioService","AlertService","$routeParams","$resource","$location","AuthenticationService","MapaService",function($scope,AnuncioService,AlertService,$routeParams,$resource,$location,AuthenticationService,MapaService){$scope.isLoja=AuthenticationService.isLoja();var anuncio=$resource("api/anuncio/"+$routeParams.id).get(function(){$scope.anuncio=anuncio,AuthenticationService.isLoja()||mapa()}),dados=$resource("api/anuncio").get(function(){$scope.dados=dados,$scope.anuncio.combustivel=_.find(dados.combustiveis,function(o){return o.combustivel==$scope.anuncio.combustivel.combustivel}),$scope.anuncio.cor=_.find(dados.cores,function(o){return o.cor==$scope.anuncio.cor.cor}),$scope.selectedMarca=_.find(dados.marcas,function(o){return o.marca==$scope.anuncio.modelo.marca.marca}),$scope.getModelo($scope.selectedMarca)});$scope.addAcessorio=function(){$scope.anuncio.acessorios.push($scope.selectedAcessorio)},$scope.limparAcessorios=function(){$scope.anuncio.acessorios=[]},$scope.getModelo=function(marca){if(null!=marca){var promisseModelo=AnuncioService.getModelo(marca);promisseModelo.then(function(data){$scope.modelos=data,""!=$scope.anuncio.modelo.nome&&($scope.anuncio.modelo=_.find(data,function(o){return o.nome==$scope.anuncio.modelo.nome}))},function(data){$scope.modelos=[]})}};var mapa=function(){var geom=angular.fromJson($scope.anuncio.localizacao),mainMarker={lat:geom.features[0].geometry.coordinates[1],lng:geom.features[0].geometry.coordinates[0],focus:!0,message:"Mova o marker para posicionar a localizção do automóvel",draggable:!0};angular.extend($scope,{defaults:{},markers:{mainMarker:angular.copy(mainMarker)}}),$scope.$on("leafletDirectiveMarker.dragend",function(event,args){var lat=args.model.lat,lng=args.model.lng;$scope.anuncio.localizacao="POINT ("+lat+" "+lng+")"}),$scope.anuncio.localizacao="POINT ("+geom.features[0].geometry.coordinates[1]+" "+geom.features[0].geometry.coordinates[0]+")"};$scope.center={lat:-30.0257548,lng:-51.1833013,zoom:13},$scope.atualizarAnuncio=function(){var promisseSalvar=AnuncioService.salvar($scope.anuncio);promisseSalvar.then(function(data){AlertService.add("success","Anúncio atualizado com sucesso."),$("#contentContainer").animate({scrollTop:0},200)},function(data){AlertService.add("danger","Erro ao realizar cadastro, verifique os dados."),$("#contentContainer").animate({scrollTop:0},200)})},$scope.deletar=function(){if(void 0!=$scope.motivo){console.log($scope.motivo);var promisseDeletar=AnuncioService.deletar($routeParams.id,$scope.motivo);promisseDeletar.then(function(data){$location.path("/anuncios")},function(data){AlertService.add("danger","Erro ao deletar o anúncio, tente novamente!"),$("#contentContainer").animate({scrollTop:0},200)})}},$scope.geocode=function(){MapaService.geocode($scope.endereco).then(function(data){data.results[0].locations.length>0&&($scope.markers.mainMarker.lat=data.results[0].locations[0].latLng.lat,$scope.markers.mainMarker.lng=data.results[0].locations[0].latLng.lng,$scope.center.lat=data.results[0].locations[0].latLng.lat,$scope.center.lng=data.results[0].locations[0].latLng.lng,$scope.anuncio.localizacao="POINT ("+data.results[0].locations[0].latLng.lat+" "+data.results[0].locations[0].latLng.lng+")")},function(data){console.log(data)})}}]),app.controller("FavoritosCtrl",["$scope","AnuncioService","AlertService",function($scope,AnuncioService,AlertService){$scope.title="Meus Favoritos",$scope.anuncios=[];var promiseAnuncios=AnuncioService.getFavoritos();promiseAnuncios.then(function(data){$scope.anuncios=data}),$scope.removerFavorito=function(id){AnuncioService.favorito("remove",id).then(function(data){AlertService.add("success","Anúncio removido dos favoritos com sucesso."),$("#contentContainer").animate({scrollTop:0},200);var promiseAnuncios=AnuncioService.getFavoritos();promiseAnuncios.then(function(data){$scope.anuncios=data})},function(data){AlertService.add("danger","Erro ao remover dos favoritos.")})}}]),app.controller("LoginCtrl",["$scope","$location","$window","LoginService","AuthenticationService","AlertService",function($scope,$location,$window,LoginService,AuthenticationService,AlertService){$scope.user={},$scope.login=function(){void 0!==$scope.user.email&&void 0!==$scope.user.senha&&LoginService.login($scope.user,function(data){$window.sessionStorage.token=data.token,$location.path("/")},function(status,data){AlertService.add("danger","Login Inválido.")})},$scope.logout=function(){AuthenticationService.isLogged()&&(delete $window.sessionStorage.token,$location.path("/login"))}}]),app.controller("MapaCtrl",["$scope","$rootScope","$filter","$modal","MapaService","AuthenticationService","$routeParams",function($scope,$rootScope,$filter,$modal,MapaService,AuthenticationService,$routeParams){$scope.title="Mapa",$scope.anunciosMarkers=[],$scope.anunciosMarkers2=[],$scope.center={lat:-30.0257548,lng:-51.1833013,zoom:12},$scope.enableMenu=!1,$scope.marcas=[{nome:"Selecione uma marca"},{nome:"Chevrolet"},{nome:"Ford"},{nome:"Fiat"},{nome:"Wolkswagen"},{nome:"Renault"},{nome:"Pegeout"},{nome:"Toyota"}],$scope.filtro={preco:{minVal:"",maxVal:"",ativo:!1},km:{minKm:"",maxKm:"",ativo:!1},ano:{minAno:"",maxAno:"",ativo:!1},marca:{marca:"",ativo:!1},modelo:"",portas:{qtdPortas:0,ativo:!1},estado:{estadoAutomovel:0,ativo:!1},fotos:{fotos:0,ativo:!1}};var icon={iconUrl:"build/img/marker-loja.png",iconSize:[41,41],iconAnchor:[12,0]},promiseAnuncios=MapaService.getAnuncios(AuthenticationService.getUser());promiseAnuncios.then(function(data){$rootScope.anuncios=data.anuncios,angular.forEach(data.anuncios,function(anuncio,i){var focus=!1;$routeParams.id&&$routeParams.id==anuncio.properties.id&&(focus=!0,$scope.center={lat:anuncio.geometry.coordinates[1],lng:anuncio.geometry.coordinates[0],zoom:18}),$scope.anunciosMarkers.push({layer:"anuncios",lat:anuncio.geometry.coordinates[1],lng:anuncio.geometry.coordinates[0],message:"<popup anuncio='anuncios["+i+"]'></popup>",popupOptions:{minWidth:240,maxWidth:300},props:anuncio.properties,focus:focus,icon:icon})}),$scope.anunciosMarkers2=$scope.anunciosMarkers}),angular.extend($scope,{defaults:{},layers:{baselayers:{osm:{name:"OpenStreetMap",type:"xyz",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}},overlays:{anuncios:{name:"Anúncios",type:"markercluster",visible:!0}}}}),$scope.$watch("filtro.modelo",function(newVal,oldVal){$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}),$scope.filtrarAnuncio=function(){$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)},$scope.limparFiltro=function(type){switch(type){case"preco":$scope.filtro.preco.minVal="",$scope.filtro.preco.maxVal="",$scope.filtro.preco.ativo=!1;break;case"km":$scope.filtro.km.minKm="",$scope.filtro.km.maxKm="",$scope.filtro.km.ativo=!1;break;case"ano":$scope.filtro.ano.minAno="",$scope.filtro.ano.maxAno="",$scope.filtro.ano.ativo=!1;break;case"marca":$scope.filtro.marca.marca=$scope.marcas[0],$scope.filtro.marca.ativo=!1;break;case"portas":$scope.filtro.portas.qtdPortas=0,$scope.filtro.portas.ativo=!1;break;case"estado":$scope.filtro.estado.estadoAutomovel=0,$scope.filtro.estado.ativo=!1;break;case"fotos":$scope.filtro.fotos.fotos=0,$scope.filtro.fotos.ativo=!1;break;default:$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}$scope.anunciosMarkers=$filter("filter")($scope.anunciosMarkers2,$scope.filtro)}}]),app.controller("ModalCtrl",function($scope,$modalInstance,anuncio,AnuncioService,AlertService){$scope.anuncio=anuncio,$scope.ok=function(){$modalInstance.dismiss("cancel")},$scope.favoritar=function(option){("add"==option||"remove"==option)&&AnuncioService.favorito(option,$scope.anuncio.properties.id).then(function(data){"add"==option?(AlertService.add("success","Adicionado as favoritos com sucesso."),$scope.anuncio.properties.favorito=!0):(AlertService.add("success","Removido dos favoritos com sucesso."),$scope.anuncio.properties.favorito=!1)},function(data){AlertService.add("danger","Erro ao adicionar aos favoritos.")})}}),app.controller("PopUpCtrl",["$scope","$modal",function($scope,$modal){$scope.openDetail=function(){$modal.open({animation:!0,templateUrl:"partials/modal.html",controller:"ModalCtrl",size:"md",resolve:{anuncio:function(){return $scope.anuncio}}})}}]),app.directive("enableMenu",function(){return{restric:"A",link:function(scope,elem,attrs){"glyphicon glyphicon-menu-up";elem.on("click",function(){$(elem).toggleClass(function(){return $(elem).is(".glyphicon-menu-down")?"glyphicon-menu-up":"glyphicon-menu-down"}),$("#containerFiltros").slideToggle("medium")})}}}),app.directive("popup",[function(){return{restrict:"E",scope:{anuncio:"="},templateUrl:"partials/popup.html",controller:"PopUpCtrl"}}]),app.directive("activeLink",["$location",function(location){return{restrict:"A",link:function(scope,element,attrs,controller){var clazz=attrs.activeLink,path=attrs.href;path=path.substring(1),scope.location=location,scope.$watch("location.path()",function(newPath){path===newPath?element.addClass(clazz):element.removeClass(clazz)})}}}]),app.directive("overflowDirective",["$location",function(location){return{restrict:"A",link:function(scope,element,attrs){"/"!=location.path()?$(element).css("overflow","auto"):$(element).css("overflow","hidden")}}}]),app.directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0])})})}}}]),app.directive("fileUpload",function(){return{scope:!0,link:function(scope,el,attrs){el.bind("change",function(event){for(var files=event.target.files,i=0;i<files.length;i++)scope.$emit("fileSelected",{file:files[i]})})}}}),app.filter("filter",[function(){return function(markers,obj){var matches=[];return angular.forEach(markers,function(marker,featureKey){marker.match=!0,""!=obj.preco.minVal&&1==marker.match&&(marker.props.valor>=obj.preco.minVal?marker.match=!0:marker.match=!1,obj.preco.ativo=!0),""!=obj.preco.maxVal&&1==marker.match&&(marker.props.valor<=obj.preco.maxVal?marker.match=!0:marker.match=!1,obj.preco.ativo=!0),""!=obj.km.minKm&&1==marker.match&&(marker.props.km>=obj.km.minKm?marker.match=!0:marker.match=!1,obj.km.ativo=!0),""!=obj.km.maxKm&&1==marker.match&&(marker.props.km<=obj.km.maxKm?marker.match=!0:marker.match=!1,obj.km.ativo=!0),""!=obj.ano.minAno&&1==marker.match&&(marker.props.ano>=obj.ano.minAno?marker.match=!0:marker.match=!1,obj.ano.ativo=!0),""!=obj.ano.maxAno&&1==marker.match&&(marker.props.ano<=obj.ano.maxAno?marker.match=!0:marker.match=!1,obj.ano.ativo=!0),""!=obj.modelo&&1==marker.match&&(marker.props.modelo.toUpperCase().indexOf(obj.modelo.toUpperCase())>-1?marker.match=!0:marker.match=!1),"Selecione uma marca"!=obj.marca.marca.nome&&1==marker.match&&(marker.props.marca.toUpperCase().indexOf(obj.marca.marca.nome.toUpperCase())>-1?marker.match=!0:marker.match=!1,obj.marca.ativo=!0),0==obj.qtdPortas&&1==marker.match?(marker.match=!0,obj.portas.ativo=!1):obj.portas.qtdPortas>0&&1==marker.match&&(marker.props.portas==obj.portas.qtdPortas?marker.match=!0:marker.match=!1,obj.portas.ativo=!0),0==obj.estado.estadoAutomovel&&1==marker.match?(marker.match=!0,obj.estado.ativo=!1):obj.estado.estadoAutomovel>0&&1==marker.match&&(marker.props.estado==obj.estado.estadoAutomovel?marker.match=!0:marker.match=!1,obj.estado.ativo=!0),0==obj.fotos.fotos&&1==marker.match?(marker.match=!0,obj.fotos.ativo=!1):1==obj.fotos.fotos&&1==marker.match?(marker.props.fotos.length>0?marker.match=!0:marker.match=!1,obj.fotos.ativo=!0):2==obj.fotos.fotos&&1==marker.match&&(0==marker.props.fotos?marker.match=!0:marker.match=!1,obj.fotos.ativo=!0),1==marker.match&&matches.push(marker)}),matches}}]),app.factory("AlertService",["$rootScope",function($rootScope){var alertService={};return $rootScope.alerts=[],alertService.add=function(type,msg){$rootScope.alerts=[],$rootScope.alerts.push({type:type,msg:msg})},alertService.clear=function(){$rootScope.alerts=[]},alertService}]),app.factory("AnuncioService",function($http,$q){return{getAnuncios:function(){var d=$q.defer(),url="api/anuncio/all";return $http.get(url).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},getFavoritos:function(){var d=$q.defer(),url="api/anuncio/favoritos";return $http.get(url).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},getAnuncio:function(id){var d=$q.defer(),url="api/anuncio/"+id;return $http.get(url).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},getData:function(){var d=$q.defer(),url="api/anuncio";return $http.get(url).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},getModelo:function(marca){var d=$q.defer(),url="modelo/"+marca.id;return $http.get(url).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},salvar:function(anuncio,files){var d=$q.defer(),url="api/anuncio/salvar";return $http({method:"POST",url:url,headers:{"Content-Type":angular.identity},transformRequest:function(data){var formData=new FormData;formData.append("anuncio",angular.toJson(data.model));for(var i in data.files)formData.append("file",data.files[i]);return formData},data:{model:anuncio,files:files}}).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},deletar:function(id,motivo){var d=$q.defer(),url="api/anuncio/deletar/"+id;return $http({method:"POST",url:url,data:angular.toJson(motivo)}).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},favorito:function(acao,id){var d=$q.defer(),url="api/anuncio/favorito/"+acao+"/"+id;return $http({method:"GET",url:url}).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise},getPrecoFipe:function(anuncio){var d=$q.defer(),url="http://fipeapi.appspot.com/api/1/carros/veiculo/"+anuncio.modelo.marca.fipe_id+"/"+anuncio.modelo.fipe_id+"/"+anuncio.ano+"-"+anuncio.combustivel.codigo+".json";return $http.get(url).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise}}}),app.factory("AuthenticationService",["$window",function($window){var auth={isLogged:function(){return void 0==$window.sessionStorage.token?!1:!0},getUser:function(){return void 0!=$window.sessionStorage.token?JSON.parse(atob($window.sessionStorage.token.split(".")[1])).nome:""},isLoja:function(){return void 0!=$window.sessionStorage.token?JSON.parse(atob($window.sessionStorage.token.split(".")[1])).loja:""}};return auth}]),app.factory("CadastroFactory",function($resource){return $resource("usuario/salvar",{},{create:{method:"POST"}})}),app.factory("LoginService",function($resource){return $resource("usuario/login",{},{login:{method:"POST"}})}),app.factory("MapaService",function($http,$q){return{getAnuncios:function(user){var d=$q.defer(),url="dados/anuncios",saida={anuncios:[]};return""!=user&&(url="api/anuncio/lista"),$http.get(url).success(function(anuncios){angular.forEach(anuncios.features,function(anuncio){saida.anuncios.push(anuncio)}),d.resolve(saida)}).error(function(msg,code){d.reject(msg)}),d.promise},geocode:function(endereco){var d=$q.defer(),url="http://open.mapquestapi.com/geocoding/v1/address";return $http.get(url,{params:{key:"NneFYreg0kkMxkfuUI39iacW1CHr6ADs",location:endereco,outFormat:"json"}}).success(function(data){d.resolve(data)}).error(function(msg,code){d.reject(msg)}),d.promise}}}),app.factory("TokenInterceptor",["$q","$window","AuthenticationService",function($q,$window,AuthenticationService){return{request:function(config){return config.headers=config.headers||{},$window.sessionStorage.token&&(config.headers.Authorization="Bearer "+$window.sessionStorage.token),config},requestError:function(rejection){return $q.reject(rejection)},response:function(response){return response||$q.when(response)},responseError:function(rejection){return $q.reject(rejection)}}}]);